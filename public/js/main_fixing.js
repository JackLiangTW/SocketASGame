var questions=[
    ["美國的首都是?","紐約","洛杉磯","華盛頓","芝加哥","3"],//--題目 選擇1 選擇2 選擇3 選擇4 答案
    ["澳洲的首都是?","伯斯","坎培拉","墨爾本","雪梨","2"],
    ["土耳其的首都是？","安塔莉亞","伊斯坦堡","安卡拉","布達佩斯","3"],
    ["瑞士的首都是？","伯恩","蘇黎世","洛桑","日內瓦","1"],
    ["越南的首都是？","清邁","胡志明市","芽莊市","河內市","4"],
    ["荷蘭的首都是？","鹿特丹","恩荷芬","霍芬海姆","阿姆斯特丹","4"],    
    ["巴西的首都是？","里約熱內盧","聖保羅","布拉才維爾","巴西利亞","4"],
    ["西班牙的首都是？","里斯本","巴塞隆納","馬德里","瓦隆西亞","3"],
    ["墨西哥的首都是？","墨西哥城","波多","德古斯加巴","克里特","1"],
    ["希臘的首都是？","雅典","安卡拉","克里特","斯巴達","1"],
    ["比利時的首都是？","哥本哈根","布魯塞爾","安特衛普","里昂","2"],
    ["伊拉克的首都是？","大馬士革","巴格達","巴士拉","摩蘇爾","2"],
    ["古巴的首都是？","哈瓦那","太子港","聖地牙哥","馬拿","1"],
    ["挪威的首都是？","赫爾辛基","特隆荷姆","斯德哥爾摩","奧斯陸","4"],
    ["捷克的首都是？","華沙","布爾諾","克拉科夫","布拉格","4"],
    ["德國的首都是？","柏林","漢堡","慕尼黑","科隆","1"],
    ["祕魯的首都是？","利馬","蘇克雷","波哥大","聖荷西","1"],
    ["加拿大的首都是？","坎培拉","渥太華","蒙特婁","多倫多","2"],
    ["葡萄牙的首都是？","馬德里","巴塞隆納","里斯本","波多","3"],
    ["瑞典的首都是？","哥本哈根","馬爾默","斯德哥爾摩","奧斯陸","3"],    
    ["波蘭的首都是？","基輔","華沙","布拉格","維爾紐斯","2"],
    ["丹麥的首都是？","哥本哈根","奧斯陸","斯德哥爾摩","鹿特丹","1"],
    ["菲律賓的首都是？","河內","吉隆波","馬尼拉","加洛砍","3"],
    ["馬來西亞的首都是？","曼谷","雅加達","河內","吉隆坡","4"],
    ["泰國的首都是？","德黑蘭","河內","金邊","曼谷","4"],
    ["伊朗的首都是？","伊斯坦堡","巴格達","德黑蘭","大馬士革","3"],
    ["敘利亞的首都是？","大馬士革","貝魯特","安曼","德黑蘭","1"],
    ["阿根廷的首都是？","利馬","布宜諾斯艾利斯","羅薩里奧","聖保羅","2"],
    ["韓國的首都是？","名古屋","平壤","首爾","釜山","3"],
    ["法國的首都是？","凡爾賽","馬賽","巴黎","里昂","3"],
    ["俄羅斯的首都是？","聖彼得堡","莫斯科","基輔","西伯利亞","2"],//--1-31
    ["3張青眼白龍融合成什麼?","青眼3頭龍","3眼青龍","青眼大白龍","青眼究極龍","4"],
    ["下列何者不是神之卡?","天空龍","翼神龍","小小兵","巨神兵","3"],
    ["武騰遊戲脖子掛著甚麼?","千年老木","千年神木","樂高積木","千年積木","4"],
    ["魯夫頭上通常戴者甚麼?","草帽","安全帽","棒球帽","絲襪","1"],
    ["魯夫會用什麼氣?","起床氣","小氣","霸氣","稚氣","3"],
    ["魯夫為甚麼不會游泳?","吃壞肚子","吃了惡魔果實","害羞穿泳裝","他假裝不會","2"],
    ["多拉A夢喜歡吃?","銅鑼燒","銅鑼灣","大阪燒","大麥克","1"],
    ["多拉A夢害怕甚麼?","館長","立法委員","考試","老鼠","4"],
    ["多拉A夢的妹妹是?","小叮嚀","小小兵","小彬彬","小小彬","1"],
    ["多拉A夢的道具有?","任意球","任意門","羅生門","小南門","2"],
    ["柯南最喜歡什麼運動?","鐵人三項","WWE","足球","三級跳遠","3"],
    ["柯南是","橫綱","立法委員","死神","小學生","4"],
    ["阿笠博士是","燒烤店老闆","衝浪冠軍","發明家","恐怖分子","3"],
    ["小蘭是","空手道冠軍","Rap高手","街舞高手","恐怖分子","1"],//-45
    ["天馬流星拳是誰的招式","星矢","孫悟空","魯夫","鳴人","1"]
    // ["下列何者在二戰時與其他國家不是同一陣線?","英國","義大利","法國","美國","2"],
    // ["3+5X3+8-7=?","19","25","21","17","1"],
    // ["3的5次方=?","15","81","243","729","3"],
    // ["下列何者體重最重?","2014年的連勝文","館長-陳之漢","2019年的連勝文","林書豪","2"],//-1-10
    // ["以下哪一個大洲的面積最大？","大洋洲","南美洲","非洲"," 亞洲","4"],
];
var Login=false;
var pushedID=[];//--myID(順序),MyDomId(APD順序/DOM id),Mynames(遊戲匿名),Myscore(分數)
var msgs;
var MyDomId="";
var myID;//--編號 ID
var Mynames="";
var Myscore=0;//--天梯積分
//--關卡Data(要重製)
var Qstage=0;//--題目階段
var Qnumbers;//--亂數題目代號
var Iplaying=false;
var MyEnermyLongID='';//--亂碼長ID
var MyEnermyScore=0;//--敵人這個關卡分數
var HasANS=false;//---選擇答案
var ChooseNB=0;//--我選擇第幾個答案
var MyNowScore=0;//--我這個關卡分數
var CanChoose=true;//--可以選擇答案
var Chstage=0;//--2個人作答的狀態  0:都沒提交  1:1個人提交 2:2人
var times=15.0;//--作答時間 秒
var TheInterval;//--計時器 題目倒數
var TheInterval2;//--計時器 判斷同步
//--關卡Data(要重製)
//--後台控制
var refuse_play=false;//--是否可以配對遊玩
//--後台控制
$(document).ready(function(){
    var socket= io();  
        socket.on("Namefalse",function(){
            alert("此名子已使用");
        });
        socket.on("NameTrue",function(msg){//--成功使用name登入

            Login=true;
            myID=msg.id;
            MyDomId="APD"+myID;

            $("#PlayerAll .container tbody").append(
                            //`<p class="myBar" id="${MyDomId}"><span>名字:${Mynames}</span><span class"scs">分數:${Myscore}</span></p>`
                            `<tr class="myBar" id="${MyDomId}"><td>${Mynames}</td><td class="scs">${Myscore}</td><td>0</td></tr>`
                        );
            pushedID.push([myID,MyDomId,Mynames,Myscore]);
            $("#Login").css("display","none");
            $("#Loged #names span").text(Mynames);
            $("#Loged #scores span").text(Myscore);
            $("#Loged").css("display","block");
        });
        socket.on("newclientconnect",function(msg){//--如果禁止對戰 新進玩家直接接收            
            refuse_play=msg.refuse_play;
        });        
        socket.on("send_msg",function(msg){//--跑馬燈加入訊息
            $('#marqueeTeach').append(`<span class='marquee_in_say'>${msg.say}</span>`);
        });
        socket.on("stop_fight",function(msg){//--給再現玩家發出 禁止對戰            
            refuse_play=msg.refuse_play;
            if(refuse_play){
                $('#marqueeTeach').append(`<span class='marquee_in_say'>遊戲對戰已結束~~</span>`);
            }else{
                $('#marqueeTeach').append(`<span class='marquee_in_say'>對戰已經開啟!</span>`);
            }            
        });

        socket.on("checkdatas",function(msg){//--檢查所有人的資料
            //console.log(msg);
            for(var i=0;i<msg.length;i++){
                var have=false;
                if(msg[i]==null){continue;}//--跳過這個i 去執行下一個i值的迴圈
                for(var a=0;a<pushedID.length;a++){
                    if(msg[i][0]==pushedID[a][0]){//--如果 已經append好 改x,y
                        //var oj=document.getElementById(pushedID[a][1]);
                        var oj="#"+pushedID[a][1];
                        $(oj).children("td").eq(1).html(msg[i][2]);
                        pushedID[a][3]=msg[i][2];//--分數更新
                        have=true;
                    }
                }//--for a END
                if(have==false){//--如果還沒append,append進去
                        var names="APD"+msg[i][0];//--APD+數字
                        var ct2=msg[i][1];
                        var ct3=msg[i][2];
                        $("#PlayerAll .container tbody").append(
                            //`<p id="${names}"><span>名字:${ct2}</span><span class"scs">分數:${ct3}</span></p>`
                            `<tr id="${names}"><td>${ct2}</td><td class"scs">${ct3}</td><td>0</td></tr>`
                        );
                        pushedID.push([msg[i][0],names,msg[i][1],msg[i][2]]);
                }
            }//--for i END
        });
        socket.on("deleteP",function(msg){//--刪除離線的人 的DOM
            var iid=msg.ids+1;
            var DD="APD"+iid;
            console.log("DELL");
            $('#'+DD).remove();
            //console.log(pushedID[msg.ids]);                
        });
        
        socket.on("GameStart",function(msg){//--配對成功 開始遊戲
            //console.log(msg.nb);
            //console.log(pushedID);
            GStart(msg);
            Question(msg.nb);
        });
        socket.on("EnermyANS",function(msg){//--傳來 對手選擇的答案
            Chstage=msg.STG;
            if(msg.ANS>0&&msg.ANS<5){
                $("#QUS .choose").eq(msg.ANS-1).addClass("EnermyChoose");
            }
            if(msg.STG==2&&ChooseNB!=0){ //--公布答案&下一提 (不同時 案送出)
                CheckANS();
            }
            if(msg.STG==1&&CanChoose==false){ //--公布答案&下一提(同時 案送出)
                CheckANS();
            }            
        });
        socket.on("EnermySCS",function(msg){//--傳來 對手此局分數
            $("#EnGameSC").text("本場分數:"+msg.Alls);
            MyEnermyScore=msg.Alls;
            setTimeout(TimeDataReset,2000);
        });
        socket.on("EnermyOut",function(){//--對戰中 對手離開
            var pp=50+MyNowScore;
            $('.resultpic').css("background-image", "url('../img/success-2.png')");
            if(Iplaying)MyEnOutGame('獲勝:對手離開',pp);
        });
        socket.on("Offline",function(msg){//--對戰中 與對手失去同步            
            var pp=50+MyNowScore;            
            if(msg.myid==MyEnermyLongID&&Iplaying)
            {   
                $('.resultpic').css("background-image", "url('../img/sad.png')");
                MyEnOutGame('與對手連線中斷',pp);  
            }          
        });            
        
    $("#Login button").on( "click", function() {//--確認名字 送出
        var values=$("#Login Input").val();
        //console.log(values.length);
        if(values.length<=8){
            Mynames=values;
            socket.emit('Checkname',{id:myID,name:values,score:Myscore,playstage:Iplaying});
        }else{
            alert('名字不可以超過8個字');
        }
        
        //socket.emit('Checkname',{name:values,score:Myscore,playstage:Iplaying});
    });
    
    $("#Loged .joingame").on( "click", function() {//---開始配對
        if(refuse_play==false){
            $("#Playing").css('display','block');
            socket.emit('Findplyer',{ids:myID-1});
            //socket.emit('Findplyer',{ids:myID});
            Iplaying=true;
        }else{
            alert("本輪賽事已結束-現在禁止對戰");
        }
    });
    $("#playsearching button").on( "click", function() {//--取消配對
        $("#Playing").css('display','none');
        socket.emit('CancelFind',{ids:myID-1});
        Iplaying=false;
    });
    $("#PlayArea #QUS button").on( "click", function() {//-案確認按鈕(送出答案)
        if(HasANS){//--向伺服器發射 我選擇的答案
            Chstage++;
            socket.emit('PlayerChoosed',{MyEN:MyEnermyLongID,MyANS:ChooseNB,Stg:Chstage});
            HasANS=false;
            CanChoose=false;//--禁止作答
            clearInterval(TheInterval);
            if(Chstage==2){CheckANS();}//--公布答案&下一提(2邊都提交)
            else if(Chstage==1){                
                var tt=parseInt(times);
                var as=(tt+3)*1000;
                var qq=Qstage;                  
                setTimeout(function() {
                    judgeEnStillInGame(qq);
                },as);
            }                              
            $("#PlayArea #QUS button").css('display','none');
        }
        else{alert("未選擇答案");}
    });
    $("#QUS .choose").on("click",function(){//--選擇題目
        if(CanChoose){
            $(this).addClass("clicked").siblings("p").removeClass("clicked");
            //console.log($("#QUS span").index(this));
            ChooseNB=$("#QUS p").index(this);
            HasANS=true;
        }
    });
    $("#Closebtn").on("click",function(){//--關閉 結算UI(完成並離開對戰)
        $("#Finished").animate({opacity:0},500,function(){$("#Finished").css('display','none');});
        CloseGameResetData();
    });
    function GStart(is){//--遊戲開始  載入對手資料,開啟UI
        $("#playsearching").css('display','none');
        $("#PlayArea").css('display','block');
        $("#Pmyself  p:nth-child(1)").text(Mynames);
        $("#Pmyself  p:nth-child(2)").text("天梯積分:"+Myscore);
        $("#MyGameSC").text("本場分數:0");
        $("#EnGameSC").text("本場分數:0");
        for(var i=0;i<pushedID.length;i++){
            if(is.ids==pushedID[i][0]){
                $("#Pother p:nth-child(1)").text(pushedID[i][2]);
                $("#Pother p:nth-child(2)").text("天梯積分:"+pushedID[i][3]);
                MyEnermyLongID=is.longid;//--對手的長ID
                break;
            }
        }
                    
    }
    function Question(nbs){//--遊戲問題 載入
        Qnumbers=nbs;
        $("#QUS p:nth-child(2)").text("第"+(Qstage+1)+"題:"+questions[nbs[Qstage]][0]);//--or $("#QUS p:nth-child(1)")
        $("#QUS p:nth-child(3)").children("span:nth-child(2)").text(questions[nbs[Qstage]][1]);
        $("#QUS p:nth-child(4)").children("span:nth-child(2)").text(questions[nbs[Qstage]][2]);
        $("#QUS p:nth-child(5)").children("span:nth-child(2)").text(questions[nbs[Qstage]][3]);
        $("#QUS p:nth-child(6)").children("span:nth-child(2)").text(questions[nbs[Qstage]][4]);
        TheInterval=setInterval(InterTimes,1000);
    }
    function CheckANS(){//--判斷選擇送出
        $("#QUS p").eq(questions[Qnumbers[Qstage]][5]).addClass("TrueANS").siblings(".choose").addClass("FalseANS");
        GetThisRecord();
    }
    function InterTimes(){//-作答計時器fuc
        if(times>0){
            times=times-1;
            document.title='剩餘作答:'+times;
            times=times.toFixed(1);
            $("#ANStime span").text(times+"s");                
        }            
        if(times<=0&&CanChoose){//--時間到
            Chstage=2;
            socket.emit('PlayerChoosed',{MyEN:MyEnermyLongID,MyANS:0,Stg:Chstage});
            HasANS=false;
            CanChoose=false;//--禁止作答                                                  
            $("#PlayArea #QUS button").css('display','none');                
            CheckANS();
            clearInterval(TheInterval);
            var qq=Qstage;                  
            setTimeout(function() {judgeEnStillInGame(qq);},3000);
        }//--超過時間未作答
    }
    function judgeEnStillInGame(qs){//--判斷對方同步同步 
        if(qs==4)//--最後一提 特蘇
        {
            if(Iplaying){
                socket.emit('Offline',{MyEN:MyEnermyLongID});
                var pp=50+MyNowScore;
                $('.resultpic').css("background-image", "url('../img/sad.png')");
                MyEnOutGame('與對手連線中斷',pp);  
            }
        }else{//--除了最後一題
            if(qs==Qstage&&Iplaying)//--題目沒切換->不同步
            {
                socket.emit('Offline',{MyEN:MyEnermyLongID});
                var pp=50+MyNowScore;
                $('.resultpic').css("background-image", "url('../img/sad.png')");
                MyEnOutGame('與對手連線中斷',pp);  
            }
        }
        
        //socket.emit('sendrequest',{MyEN:MyEnermyLongID});
    }
    function GetThisRecord(){//--結算本關成績
        clearInterval(TheInterval);
        var scs=0;
            //console.log(times);
        if(ChooseNB==questions[Qnumbers[Qstage]][5]){//-答對
            scs=Math.ceil(times);
           // console.log(scs);
            MyNowScore=MyNowScore+scs;
        }else{//--答錯
            scs=0;
            MyNowScore=MyNowScore+0;
        }
        //console.log(MyNowScore);
        $("#MyGameSC").text("本場分數:"+MyNowScore);
        socket.emit('MyScoreToEnermy',{MyEN:MyEnermyLongID,PlusSC:scs,AllSC:MyNowScore});//--傳我這局的成績給敵人        
    }
    function TimeDataReset(){//--關閉計時器+重設參數       
        $("#PlayArea #QUS button").css('display','inline-block');
        $("#QUS .choose").removeClass("clicked");
        $("#QUS p").removeClass("TrueANS").removeClass("FalseANS");
        $("#QUS .choose").removeClass("EnermyChoose");
        if(Qstage<4){//--進行下一提
            Qstage++;
            times=15.0;
            HasANS=false;
            ChooseNB=0;
            CanChoose=true;
            Chstage=0;
            Question(Qnumbers);
        }
        else{//--完成所有題目
            Iplaying=false;
            var Fstage="";
            var Fplus=0;
            console.log(MyNowScore);
            console.log(MyEnermyScore);
            if(MyNowScore>MyEnermyScore){//--贏
                Myscore=Myscore+MyNowScore+50;
                Fstage="獲勝";
                Fplus=MyNowScore+50;
                $('.resultpic').css("background-image", "url('../img/success-2.png')");
            }else if(MyNowScore<MyEnermyScore){//--輸
                Myscore=Myscore+MyNowScore;
                Fstage="落敗";
                Fplus=MyNowScore;
                $('.resultpic').css("background-image", "url('../img/sad.png')");
            }else{//-平手
                Myscore=Myscore+MyNowScore+25;
                Fstage="平手";
                Fplus=MyNowScore+25;
                $('.resultpic').css("background-image", "url('../img/agreement.png')");
            }
            $("#Panels .Content .Result").text(Fstage);
            $("#Panels .Content .GetPoints").text("天梯積分+"+Fplus);
            $("#Finished").css('display','block').animate({opacity:1},500);       
            //socket.emit('SuccessGame',{id:myID-1,Scores:Myscore});//--傳我這局的成績給敵人   3/11 DownHere
        }
    }
    function CloseGameResetData(){//---離開遊戲房間(重製Data)         
         Qstage=0;//--題目階段
         Qnumbers=[];//--亂數題目代號
         Iplaying=false;
         MyEnermyLongID='';//--亂碼長ID
         MyEnermyScore=0;//--敵人這個關卡分數 
         HasANS=false;//---選擇答案
         ChooseNB=0;//--我選擇第幾個答案
         MyNowScore=0;//--我這個關卡分數
         CanChoose=true;//--可以選擇答案
         Chstage=0;//--2個人作答的狀態  0:都沒提交  1:1個人提交 2:2人
         times=15.0;//--作答時間 秒         
         $("#playsearching").css('display','block');
         $("#PlayArea").css('display','none');
         $("#Playing").css('display','none');
         socket.emit('CancelFind',{ids:myID-1});
         socket.emit('UpdateMyScore',{ids:myID,newSC:Myscore});
         //console.log(pushedID);
         Iplaying=false;
         $("#Loged #scores span").text(Myscore);//--更新首頁自己的分數
    }
    function MyEnOutGame(say,point){//--對手中離
        Iplaying=false;
        $("#PlayArea #QUS button").css('display','inline-block');
        $("#QUS .choose").removeClass("clicked");
        $("#QUS p").removeClass("TrueANS").removeClass("FalseANS");
        $("#QUS .choose").removeClass("EnermyChoose");
        CloseGameResetData();
        clearInterval(TheInterval);
        // $("#Panels .Content .Result").text('獲勝:對手離開');
        // Myscore=Myscore+MyNowScore+50;
        // var insay=MyNowScore+50;
        $("#Panels .Content .Result").text(say);
        Myscore=Myscore+MyNowScore+point;
        var insay=MyNowScore+point;
        $("#Panels .Content .GetPoints").text("天梯積分+"+insay);
        $("#Finished").css('display','block').animate({opacity:1},500);       
    }

    $('#For_rank').on('click',Ranking_sort);

    function Ranking_sort(){//--<td>所有資料排名
        var R_allnb=$("#PlayerAll .container tbody tr").length;
        var Datas=[];            
        for(i=0;i<R_allnb;i++){
            var vv=$("#PlayerAll .container tbody tr").eq(i);
            var vv2=vv.children('td:nth-child(2)').html();
            var vvv=[vv,vv2];
            Datas.push(vvv);
            //console.log('RR:'+vv2);
        }
        Datas.sort(function (a, b) {//--小到最大
            return a[1] - b[1];
        });
        Ranking_do(Datas);            
    }
    function Ranking_do(data){//--Dom畫面排名更動
        for(i=0;i<data.length;i++){                
            var a=$("#PlayerAll .container tbody tr").eq(i);               
            var s=data.length-(i+1);
            data[s][0].insertBefore(a);//--data移動到a(DOM)之前
            data[s][0].children('td:last-child').html(i+1);
        }
    }
    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

});